<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンラインオセロ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* オセロの駒の見た目 */
        .piece {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: transform 0.3s ease-in-out;
            transform-style: preserve-3d;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 駒のひっくり返しアニメーション */
        @keyframes flip-to-white {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(180deg); }
        }

        @keyframes flip-to-black {
            0% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }

        .flip-to-white { animation: flip-to-white 0.5s forwards; }
        .flip-to-black { animation: flip-to-black 0.5s forwards; }

        /* カーソルを合わせると表示される、駒を置ける場所のヒント */
        .valid-move-hint::after {
            content: '';
            display: block;
            width: 1rem;
            height: 1rem;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div class="max-w-4xl w-full mx-auto p-8 bg-gray-800 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-emerald-400">オンラインオセロ</h1>
        
        <!-- プレイヤーID表示エリア -->
        <div class="mb-6 bg-gray-700 p-4 rounded-lg">
            <p class="text-lg font-semibold">あなたのプレイヤーID:</p>
            <div class="flex items-center mt-2">
                <span id="player-id-display" class="font-mono bg-gray-900 text-emerald-300 p-2 rounded-md truncate w-full">Loading...</span>
                <button id="copy-id-btn" class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">コピー</button>
            </div>
            <p class="text-sm mt-2 text-gray-400">このIDを対戦相手に共有してください。相手のIDを入力してゲームを開始できます。</p>
        </div>

        <!-- 相手のプレイヤーID入力エリア -->
        <div class="mb-6 bg-gray-700 p-4 rounded-lg">
            <p class="text-lg font-semibold">対戦相手のIDを入力:</p>
            <div class="flex items-center mt-2">
                <input id="opponent-id-input" type="text" placeholder="対戦相手のプレイヤーID" class="flex-grow bg-gray-900 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-400">
                <button id="join-game-btn" class="ml-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors duration-200">ゲームに参加</button>
            </div>
        </div>

        <!-- ゲーム情報表示エリア -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-gray-700 p-4 rounded-lg">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <p id="status-message" class="text-2xl font-bold text-emerald-300">ゲームをロード中...</p>
                <p id="turn-info" class="text-lg text-gray-300">対戦相手を待っています</p>
            </div>
            <div class="flex space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="w-8 h-8 rounded-full bg-black border-2 border-gray-400"></span>
                    <span id="black-score" class="text-3xl font-bold">2</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="w-8 h-8 rounded-full bg-white border-2 border-gray-400"></span>
                    <span id="white-score" class="text-3xl font-bold">2</span>
                </div>
            </div>
        </div>

        <!-- オセロ盤 -->
        <div id="othello-board" class="grid grid-cols-8 gap-1 mx-auto bg-emerald-600 border-4 border-emerald-700 rounded-lg p-2 max-w-lg aspect-square">
            <!-- JavaScriptでマス目が生成されます -->
        </div>

        <!-- 操作ボタン -->
        <div class="flex justify-center mt-6">
            <button id="new-game-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-200 text-lg">新しいゲームを開始</button>
        </div>
        
    </div>

    <!-- メッセージボックスのHTML -->
    <div id="message-box" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center border border-gray-700">
            <p id="message-box-text" class="text-lg font-semibold mb-4 text-white"></p>
            <button id="message-box-close" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">閉じる</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDKのインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバル変数
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // DOM要素
        const boardEl = document.getElementById('othello-board');
        const statusMessageEl = document.getElementById('status-message');
        const turnInfoEl = document.getElementById('turn-info');
        const blackScoreEl = document.getElementById('black-score');
        const whiteScoreEl = document.getElementById('white-score');
        const playerIdDisplayEl = document.getElementById('player-id-display');
        const opponentIdInputEl = document.getElementById('opponent-id-input');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const newGameBtn = document.getElementById('new-game-btn');
        const messageBoxEl = document.getElementById('message-box');
        const messageBoxTextEl = document.getElementById('message-box-text');
        const messageBoxCloseBtn = document.getElementById('message-box-close');

        // FirestoreとAuthのインスタンス
        let app, db, auth;
        let userId = null;
        let gameId = null;

        // ゲームの状態
        let gameState = {
            board: [],
            currentPlayer: 1, // 1: 黒, 2: 白
            blackScore: 0,
            whiteScore: 0,
            players: {}, // { black: uid, white: uid }
            isGameOver: false,
            winner: null
        };

        // カスタムメッセージボックスを表示
        function showMessage(message) {
            messageBoxTextEl.textContent = message;
            messageBoxEl.classList.remove('hidden');
        }

        // カスタムメッセージボックスを非表示
        messageBoxCloseBtn.addEventListener('click', () => {
            messageBoxEl.classList.add('hidden');
        });

        // Firebase初期化と認証
        async function initializeFirebase() {
            try {
                // Firebase設定が有効かチェック
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebaseの設定が有効ではありません。APIキーがありません。");
                    statusMessageEl.textContent = "ゲームのロードに失敗しました: Firebaseの設定エラー";
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await (initialAuthToken ? signInWithCustomToken(auth, initialAuthToken) : signInAnonymously(auth));
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        playerIdDisplayEl.textContent = userId;
                        console.log("Firebase認証完了。ユーザーID:", userId);

                        // ユーザーIDに基づいてゲームをロードする
                        // 既に進行中のゲームがあるかチェック
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                        getDoc(userDocRef).then(docSnap => {
                            if (docSnap.exists() && docSnap.data().currentGameId) {
                                gameId = docSnap.data().currentGameId;
                                listenToGameChanges();
                            } else {
                                statusMessageEl.textContent = "新しいゲームを開始するか、対戦相手のIDを入力してください。";
                                turnInfoEl.textContent = "";
                            }
                        });

                    } else {
                        console.log("Firebase認証に失敗しました。");
                    }
                });

            } catch (error) {
                console.error("Firebaseの初期化または認証エラー:", error);
                statusMessageEl.textContent = `ゲームのロードに失敗しました: ${error.message}`;
            }
        }
        
        // Firestoreからゲームの状態をリアルタイムで取得
        function listenToGameChanges() {
            if (!gameId) {
                console.error("ゲームIDが設定されていません。");
                return;
            }
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', gameId);
            onSnapshot(gameDocRef, (doc) => {
                if (doc.exists()) {
                    gameState = doc.data();
                    console.log("ゲームの状態を更新:", gameState);
                    updateUI();
                } else {
                    console.log("ゲームが見つかりません。");
                    // 新しいゲームを強制的に作成するか、UIをリセットする
                    resetGame();
                    saveGameState();
                }
            }, (error) => {
                console.error("Firestoreからのデータ取得エラー:", error);
            });
        }

        // ゲームの状態をFirestoreに保存
        async function saveGameState() {
            if (!gameId) {
                console.error("ゲームIDが設定されていません。");
                return;
            }
            const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', gameId);
            try {
                await setDoc(gameDocRef, gameState);
            } catch (error) {
                console.error("Firestoreへの保存エラー:", error);
            }
        }

        // ゲーム盤の初期化
        function initializeBoard() {
            const board = [];
            for (let i = 0; i < 8; i++) {
                board[i] = new Array(8).fill(0); // 0: 空, 1: 黒, 2: 白
            }
            board[3][3] = 2; // 白
            board[3][4] = 1; // 黒
            board[4][3] = 1; // 黒
            board[4][4] = 2; // 白
            return board;
        }

        // ゲームのリセット
        function resetGame() {
            gameState.board = initializeBoard();
            gameState.currentPlayer = 1;
            gameState.blackScore = 2;
            gameState.whiteScore = 2;
            gameState.isGameOver = false;
            gameState.winner = null;
            gameState.players = {};
        }

        // 盤面の描画
        function renderBoard() {
            boardEl.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('aspect-square', 'relative', 'rounded-lg', 'transition-colors', 'duration-100', 'hover:bg-emerald-500');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    const pieceContainer = document.createElement('div');
                    pieceContainer.classList.add('absolute', 'top-1/2', 'left-1/2', '-translate-x-1/2', '-translate-y-1/2', 'w-3/4', 'h-3/4', 'p-1');
                    
                    const piece = document.createElement('div');
                    piece.classList.add('piece');
                    pieceContainer.appendChild(piece);
                    cell.appendChild(pieceContainer);

                    if (gameState.board[r][c] === 1) {
                        piece.classList.add('bg-black', 'border', 'border-gray-400');
                    } else if (gameState.board[r][c] === 2) {
                        piece.classList.add('bg-white', 'border', 'border-gray-400');
                    }

                    // 駒が置ける場所をハイライトする
                    if (!gameState.isGameOver && gameState.players[currentPlayerText()] === userId && canPlacePiece(r, c, gameState.currentPlayer)) {
                        cell.classList.add('cursor-pointer', 'valid-move-hint');
                        cell.addEventListener('click', handleCellClick);
                    }
                    boardEl.appendChild(cell);
                }
            }
        }
        
        // プレイヤー1と2のテキストを返すヘルパー関数
        const currentPlayerText = () => gameState.currentPlayer === 1 ? 'black' : 'white';
        const opponentPlayerText = () => gameState.currentPlayer === 1 ? 'white' : 'black';

        // UIの更新
        function updateUI() {
            renderBoard();
            updateScores();
            
            if (gameState.isGameOver) {
                statusMessageEl.textContent = `ゲーム終了！`;
                if (gameState.winner) {
                    turnInfoEl.textContent = `${gameState.winner === 1 ? '黒' : '白'}の勝ちです！`;
                } else {
                    turnInfoEl.textContent = "引き分けです。";
                }
            } else {
                statusMessageEl.textContent = `${gameState.currentPlayer === 1 ? '黒' : '白'}のターンです`;
                
                // 自分のターンか、相手のターンかを判定
                if (gameState.players[currentPlayerText()] === userId) {
                    turnInfoEl.textContent = "あなたの手番です。";
                } else if (gameState.players[opponentPlayerText()] === userId) {
                    turnInfoEl.textContent = "相手の手番です。";
                } else if (Object.keys(gameState.players).length < 2) {
                    turnInfoEl.textContent = "対戦相手を待っています...";
                } else {
                    // 観戦者
                    turnInfoEl.textContent = `現在、${gameState.currentPlayer === 1 ? '黒' : '白'}がプレイ中です。`;
                }

                // パス判定
                if (!hasValidMoves(gameState.currentPlayer)) {
                    statusMessageEl.textContent = `駒を置く場所がないため、${gameState.currentPlayer === 1 ? '黒' : '白'}はパスします。`;
                    setTimeout(() => {
                        passTurn();
                    }, 1500);
                }
            }
        }
        
        // スコアを更新
        function updateScores() {
            blackScoreEl.textContent = gameState.blackScore;
            whiteScoreEl.textContent = gameState.whiteScore;
        }

        // ゲームの終了を判定
        function checkGameOver() {
            if (!hasValidMoves(1) && !hasValidMoves(2)) {
                gameState.isGameOver = true;
                if (gameState.blackScore > gameState.whiteScore) {
                    gameState.winner = 1;
                } else if (gameState.whiteScore > gameState.blackScore) {
                    gameState.winner = 2;
                } else {
                    gameState.winner = 0; // 引き分け
                }
                saveGameState();
            }
        }

        // 駒をひっくり返す
        function flipPieces(row, col, player) {
            const opponent = player === 1 ? 2 : 1;
            let flippedCount = 0;
            const newBoard = JSON.parse(JSON.stringify(gameState.board));

            // 全8方向をチェック
            const directions = [
                [-1, -1], [-1, 0], [-1, 1],
                [0, -1],           [0, 1],
                [1, -1], [1, 0], [1, 1]
            ];

            directions.forEach(([dr, dc]) => {
                let r = row + dr;
                let c = col + dc;
                let tempFlipped = [];

                while (r >= 0 && r < 8 && c >= 0 && c < 8 && newBoard[r][c] === opponent) {
                    tempFlipped.push([r, c]);
                    r += dr;
                    c += dc;
                }

                if (r >= 0 && r < 8 && c >= 0 && c < 8 && newBoard[r][c] === player) {
                    tempFlipped.forEach(([fr, fc]) => {
                        newBoard[fr][fc] = player;
                        flippedCount++;
                    });
                }
            });

            if (flippedCount > 0) {
                newBoard[row][col] = player;
                gameState.board = newBoard;
                gameState.blackScore = newBoard.flat().filter(p => p === 1).length;
                gameState.whiteScore = newBoard.flat().filter(p => p === 2).length;
            }
        }

        // 駒を置ける場所があるかを判定
        function hasValidMoves(player) {
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (canPlacePiece(r, c, player)) {
                        return true;
                    }
                }
            }
            return false;
        }

        // 指定された場所に駒を置けるか判定
        function canPlacePiece(row, col, player) {
            if (gameState.board[row][col] !== 0) return false;

            const opponent = player === 1 ? 2 : 1;
            const directions = [
                [-1, -1], [-1, 0], [-1, 1],
                [0, -1],           [0, 1],
                [1, -1], [1, 0], [1, 1]
            ];

            for (const [dr, dc] of directions) {
                let r = row + dr;
                let c = col + dc;
                let foundOpponent = false;

                while (r >= 0 && r < 8 && c >= 0 && c < 8) {
                    if (gameState.board[r][c] === opponent) {
                        foundOpponent = true;
                    } else if (gameState.board[r][c] === player && foundOpponent) {
                        return true;
                    } else {
                        break;
                    }
                    r += dr;
                    c += dc;
                }
            }
            return false;
        }

        // パス
        function passTurn() {
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            saveGameState();
        }

        // マスがクリックされたときの処理
        async function handleCellClick(e) {
            if (gameState.isGameOver) return;
            // 自分のターンでなければ何もしない
            if (gameState.players[currentPlayerText()] !== userId) return;

            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);

            if (canPlacePiece(row, col, gameState.currentPlayer)) {
                // 駒をひっくり返し、状態を更新
                flipPieces(row, col, gameState.currentPlayer);
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                
                checkGameOver();
                await saveGameState();
            }
        }
        
        // 新しいゲームを開始
        newGameBtn.addEventListener('click', async () => {
            if (userId) {
                gameId = `game-${userId}-${Date.now()}`;
                resetGame();
                gameState.players.black = userId;
                
                // ユーザーのゲームIDを更新
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                await setDoc(userDocRef, { currentGameId: gameId });
                
                await saveGameState();
                listenToGameChanges();
            }
        });
        
        // ゲームに参加
        joinGameBtn.addEventListener('click', async () => {
            if (userId) {
                const opponentId = opponentIdInputEl.value.trim();
                if (opponentId) {
                    // 相手のcurrentGameIdを検索
                    const opponentDocRef = doc(db, 'artifacts', appId, 'users', opponentId);
                    const opponentDocSnap = await getDoc(opponentDocRef);

                    if (opponentDocSnap.exists() && opponentDocSnap.data().currentGameId) {
                        gameId = opponentDocSnap.data().currentGameId;
                        const gameDocRef = doc(db, 'artifacts', appId, 'public', 'data', gameId);
                        const gameDocSnap = await getDoc(gameDocRef);

                        if (gameDocSnap.exists()) {
                            const currentPlayers = gameDocSnap.data().players;
                            if (Object.keys(currentPlayers).length < 2) {
                                // 2人目のプレイヤーとして参加
                                await updateDoc(gameDocRef, {
                                    [`players.white`]: userId
                                });

                                // ユーザーのゲームIDを更新
                                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                                await setDoc(userDocRef, { currentGameId: gameId });

                                listenToGameChanges();
                            } else {
                                statusMessageEl.textContent = "このゲームはすでに2人でプレイ中です。";
                            }
                        } else {
                            statusMessageEl.textContent = "指定されたゲームIDが見つかりません。";
                        }
                    } else {
                        statusMessageEl.textContent = "指定されたプレイヤーIDは有効なゲームをホストしていません。";
                    }
                }
            }
        });

        // プレイヤーIDをクリップボードにコピー
        copyIdBtn.addEventListener('click', () => {
            const playerId = playerIdDisplayEl.textContent;
            if (playerId && playerId !== 'Loading...') {
                const tempInput = document.createElement('input');
                tempInput.value = playerId;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showMessage("プレイヤーIDがクリップボードにコピーされました！");
                } catch (err) {
                    showMessage('コピーに失敗しました。');
                }
                document.body.removeChild(tempInput);
            }
        });
        
        // 初期化
        initializeFirebase();

    </script>
</body>
</html>
