<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECMWF é™æ°´äºˆæ¸¬</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã‚’ç¶™æ‰¿ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; color: #333; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 160px; left: 0; right: 0; background: #ddd; }

        .controls {
            position: absolute; bottom: 0; left: 0; right: 0; height: 160px;
            background: rgba(255, 255, 255, 0.98); padding: 10px 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .button-group { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        button { padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; font-size: 12px; }
        button.fetched { background: #4caf50 !important; color: white !important; border-color: #388e3c; }

        .slider-container { position: relative; width: 95%; margin: 25px auto 10px; }
        input[type="range"] { width: 100%; cursor: pointer; height: 10px; }
        
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®åˆæœŸçŠ¶æ…‹ã‚’éè¡¨ç¤ºã«ã›ãšã€ä½ç½®è¨ˆç®—ã‚’å®‰å®šã•ã›ã‚‹ */
        #sliderTooltip {
            position: absolute; top: -35px; transform: translateX(-50%);
            background: #2196F3; color: white; padding: 4px 10px;
            border-radius: 4px; font-size: 11px; white-space: nowrap;
            display: none; /* æœ€åˆã ã‘éè¡¨ç¤º */
            pointer-events: none; z-index: 2000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #sliderTooltip::after {
            content: ""; position: absolute; bottom: -5px; left: 50%;
            transform: translateX(-50%); border-width: 5px 5px 0;
            border-style: solid; border-color: #2196F3 transparent transparent;
        }

        .date-markers { position: relative; height: 20px; width: 100%; margin-top: 5px; font-size: 10px; color: #666; }
        .date-marker { position: absolute; transform: translateX(-50%); border-left: 1px solid #ccc; padding-left: 3px; }

        .info-box {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.9); padding: 12px;
            border-radius: 8px; z-index: 1000; font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); min-width: 200px;
        }

        .legend {
            position: absolute; bottom: 180px; right: 10px;
            background: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; font-size: 11px;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-top: 2px; }
        .color-box { width: 15px; height: 10px; border-radius: 2px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="legend">
    <div style="font-weight:bold; margin-bottom:5px;">é™æ°´é‡ (mm/h)</div>
    <div id="legendBar"></div>
</div>

<div class="info-box">
    <div id="timeDisplay">ğŸ“… æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div id="rainDisplay">é™æ°´é‡: -- mm/h</div>
    <div id="status" style="color:#2196F3; font-weight:bold; font-size:11px;">å¾…æ©Ÿä¸­</div>
</div>

<div class="controls">
    <div class="button-group">
        <button onclick="fetchData(1)" id="btn1">1æ—¥åˆ†</button>
        <button onclick="fetchData(2)" id="btn2">2æ—¥åˆ†</button>
        <button onclick="fetchData(3)" id="btn3">3æ—¥åˆ†</button>
        <button onclick="fetchData(7)" id="btn7">1é€±é–“åˆ†</button>
        <button onclick="fetchData(14)" id="btn14">2é€±é–“åˆ†</button>
    </div>

    <div class="slider-container">
        <div id="sliderTooltip">æ™‚åˆ»</div>
        <input type="range" id="timeSlider" min="0" max="0" value="0" disabled 
               oninput="onSliderInput(this)" 
               onmousedown="showAndUpdateTooltip(this)"
               ontouchstart="showAndUpdateTooltip(this)">
        <div class="date-markers" id="dateMarkers"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([36.5, 137.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OSM', opacity: 0.8 }).addTo(map);

    let maxDaysFetched = 0;
    let weatherData = []; 
    let currentOverlay = null;

    const rainLevels = [
        { limit: 0.1, color: {r:0, g:0, b:0, a:0}, label: '0' },
        { limit: 1.0, color: {r:100, g:200, b:255, a:140}, label: '0.1-1' },
        { limit: 5.0, color: {r:50, g:150, b:255, a:180}, label: '1-5' },
        { limit: 10.0, color: {r:0, g:255, b:100, a:200}, label: '5-10' },
        { limit: 20.0, color: {r:255, g:255, b:0, a:210}, label: '10-20' },
        { limit: 999, color: {r:255, g:50, b:0, a:220}, label: '20+' }
    ];

    rainLevels.slice(1).reverse().forEach(lvl => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = `<div class="color-box" style="background:rgba(${lvl.color.r},${lvl.color.g},${lvl.color.b},${lvl.color.a/255})"></div><span>${lvl.label}</span>`;
        document.getElementById('legendBar').appendChild(item);
    });

    const grid = [];
    for(let lat=24; lat<=46; lat+=2.0) for(let lon=123; lon<=148; lon+=2.0) grid.push({lat, lon});

    async function fetchData(targetDays) {
        if (targetDays <= maxDaysFetched) return;
        document.getElementById('status').textContent = `å–å¾—ä¸­... (${targetDays}æ—¥åˆ†)`;
        try {
            const requests = grid.map(p => fetch(`https://api.open-meteo.com/v1/ecmwf?latitude=${p.lat}&longitude=${p.lon}&hourly=precipitation&forecast_days=${targetDays}`).then(r => r.json()));
            const results = await Promise.all(requests);
            results[0].hourly.time.forEach((time, tIdx) => {
                if (!weatherData.find(d => d.time === time)) {
                    weatherData.push({ time, points: results.map(res => ({ lat: res.latitude, lon: res.longitude, val: res.hourly.precipitation[tIdx] })) });
                }
            });
            weatherData.sort((a, b) => new Date(a.time) - new Date(b.time));
            maxDaysFetched = targetDays;
            updateUI();
            if (document.getElementById('timeSlider').disabled) {
                document.getElementById('timeSlider').disabled = false;
                setSliderToCurrentTime();
            } else { updateMap(); }
            document.getElementById('status').textContent = `âœ“ å®Œäº†`;
        } catch (e) { document.getElementById('status').textContent = "âœ— å–å¾—ã‚¨ãƒ©ãƒ¼"; }
    }

    function updateUI() {
        [1, 2, 3, 7, 14].forEach(d => { if(d <= maxDaysFetched) document.getElementById(`btn${d}`).classList.add('fetched'); });
        const slider = document.getElementById('timeSlider');
        slider.max = weatherData.length - 1;
        
        const markers = document.getElementById('dateMarkers');
        markers.innerHTML = '';
        weatherData.forEach((d, i) => {
            const dateObj = new Date(d.time);
            if (dateObj.getHours() === 0) {
                const el = document.createElement('div');
                el.className = 'date-marker';
                el.style.left = `${(i / slider.max) * 100}%`;
                el.innerText = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                markers.appendChild(el);
            }
        });
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚
    function onSliderInput(el) {
        updateMap();
        updateTooltip(el);
    }

    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ã«è¡¨ç¤ºã‚’é–‹å§‹ã—ã€æ›´æ–°ã™ã‚‹
    function showAndUpdateTooltip(el) {
        document.getElementById('sliderTooltip').style.display = 'block';
        updateTooltip(el);
    }

    function updateTooltip(el) {
        const tooltip = document.getElementById('sliderTooltip');
        const val = parseInt(el.value);
        if(!weatherData[val]) return;
        
        const d = new Date(weatherData[val].time);
        const dayNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
        tooltip.innerText = `${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]}) ${d.getHours()}:00`;
        
        // ã¤ã¾ã¿ã®ä½ç½®ã«åˆã‚ã›ã¦ç§»å‹•ï¼ˆè£œæ­£å€¤ã‚’è¿½åŠ ã—ã¦ç²¾åº¦å‘ä¸Šï¼‰
        const percent = (val / el.max) * 100;
        // calcå†…ã®15pxã¯ã¤ã¾ã¿ã®å¹…ã«åˆã‚ã›ãŸå¾®èª¿æ•´ç”¨
        tooltip.style.left = `calc(${percent}% + (${(50 - percent) * 0.2}px))`;
    }

    function setSliderToCurrentTime() {
        const now = new Date();
        let closestIdx = 0, minDiff = Infinity;
        weatherData.forEach((d, i) => {
            const diff = Math.abs(new Date(d.time) - now);
            if (diff < minDiff) { minDiff = diff; closestIdx = i; }
        });
        const slider = document.getElementById('timeSlider');
        slider.value = closestIdx;
        
        // åˆæœŸè¡¨ç¤ºæ™‚ã‚‚ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’å‡ºã—ã¦ãŠããªã‚‰ã“ã“ã‚’æœ‰åŠ¹åŒ–
        showAndUpdateTooltip(slider); 
        updateMap();
    }

    function updateMap() {
        const idx = parseInt(document.getElementById('timeSlider').value);
        const data = weatherData[idx];
        if (!data) return;
        const d = new Date(data.time);
        const dayNames = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
        document.getElementById('timeDisplay').innerText = `ğŸ“… ${d.getMonth()+1}/${d.getDate()}(${dayNames[d.getDay()]}) ${d.getHours()}:00`;
        
        if (currentOverlay) map.removeLayer(currentOverlay);
        const bounds = [[24, 123], [46, 148]];
        const CanvasLayer = L.ImageOverlay.extend({ _initImage: function() { this._image = L.DomUtil.create('canvas', 'leaflet-image-layer'); } });
        currentOverlay = new CanvasLayer('', bounds, { opacity: 0.65 }).addTo(map);
        const canvas = currentOverlay.getElement();
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 400;
        const imgData = ctx.createImageData(canvas.width, canvas.height);
        for (let y = 0; y < canvas.height; y++) {
            for (let x = 0; x < canvas.width; x++) {
                const val = interpolateIDW(123 + (x / 400) * 25, 46 - (y / 400) * 22, data.points);
                const color = getRainColor(val);
                const i = (y * 400 + x) * 4;
                imgData.data[i] = color.r; imgData.data[i+1] = color.g; imgData.data[i+2] = color.b; imgData.data[i+3] = color.a;
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }

    map.on('click', (e) => {
        const idx = document.getElementById('timeSlider').value;
        if(!weatherData[idx]) return;
        const val = interpolateIDW(e.latlng.lng, e.latlng.lat, weatherData[idx].points);
        L.popup().setLatLng(e.latlng).setContent(`<strong>é™æ°´é‡äºˆæ¸¬</strong><br>${val.toFixed(2)} mm/h`).openOn(map);
    });

    function interpolateIDW(lon, lat, points) {
        let n=0, d=0;
        for(const p of points) {
            const dist = Math.sqrt((lon-p.lon)**2 + (lat-p.lat)**2);
            if(dist < 0.2) return p.val;
            const w = 1 / (dist**2);
            n += w * p.val; d += w;
        }
        return d > 0 ? n/d : 0;
    }

    function getRainColor(v) {
        for (const lvl of rainLevels) { if (v < lvl.limit) return lvl.color; }
        return rainLevels[rainLevels.length - 1].color;
    }

    map.on('mousemove', (e) => {
        const idx = document.getElementById('timeSlider').value;
        if(!weatherData[idx]) return;
        const val = interpolateIDW(e.latlng.lng, e.latlng.lat, weatherData[idx].points);
        document.getElementById('rainDisplay').innerText = `é™æ°´é‡: ${val.toFixed(2)} mm/h`;
    });
</script>
</body>
</html>