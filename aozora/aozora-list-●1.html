<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’ç©ºæ–‡åº«ä¸€è¦§ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰æŠ½å‡ºï¼‰</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Yu Gothic','Hiragino Kaku Gothic Pro', sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; padding:20px;
        }
        .container {
            max-width:1200px; margin:0 auto; background:white; border-radius:16px;
            box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden;
        }
        .header {
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            padding:20px 30px; color:white; display:flex; justify-content:space-between; align-items:center;
        }
        .header h1 { font-size:24px; }
        .font-control { display:flex; align-items:center; gap:10px; }
        .font-control label { font-size:14px; }
        .font-control input {
            padding:6px 10px; border:2px solid white; border-radius:6px; font-size:14px; width:80px;
        }
        .loading { padding:40px; text-align:center; color:#6c757d; font-size:18px; }
        .book-list { padding:20px 30px; max-height:calc(100vh - 200px); overflow-y:auto; }
        .book-item { padding:8px 0; border-bottom:1px solid #f0f0f0; display:flex; transition:background 0.2s; }
        .book-item:hover { background:#f8f9fa; }
        .book-item:last-child { border-bottom:none; }
        .creator { color:#6c757d; font-size:14px; width:150px; flex-shrink:0; padding-right:10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .title-link { color:#667eea; text-decoration:none; font-size:14px; transition:color 0.2s; flex:1; }
        .title-link:hover { color:#764ba2; text-decoration:underline; }
        .error { padding:40px; text-align:center; color:#dc3545; line-height:1.8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š é’ç©ºæ–‡åº«ä¸€è¦§ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åãƒ™ãƒ¼ã‚¹ï¼‰</h1>
            <div class="font-control">
                <label for="fontSize">ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º:</label>
                <input type="text" id="fontSize" value="16px" />
            </div>
        </div>

        <div id="content">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
    (function(){
        const contentDiv = document.getElementById('content');
        const fontSizeInput = document.getElementById('fontSize');
        let fileList = [];

        // Cookie helpers
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        function setCookie(name, value, days=365) {
            const date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            const expires = `expires=${date.toUTCString()}`;
            document.cookie = `${name}=${value};${expires};path=/`;
        }

        // restore font size
        const savedFontSize = getCookie('aozoraFontSize');
        if (savedFontSize) fontSizeInput.value = savedFontSize;
        fontSizeInput.addEventListener('input', () => {
            setCookie('aozoraFontSize', fontSizeInput.value);
            if (fileList.length > 0) displayBooks();
        });

        // ---------- ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ä½œè€…ãƒ»ä½œå“åã‚’æŠ½å‡ºã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ----------
        // decodeURIComponent å®‰å…¨ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆç„¡åŠ¹ãª %xx ã‚’å«ã‚€å ´åˆã«å‚™ãˆã‚‹ï¼‰
        function safeDecodeURIComponent(s) {
            try { return decodeURIComponent(s); }
            catch(e) {
                try { return decodeURIComponent(s.replace(/\+/g, ' ')); }
                catch(e2) { return s; }
            }
        }

        // æ‹¡å¼µå­ã‚’é™¤å»
        function stripExtension(name) {
            return name.replace(/\.(html?|xhtml)$/i, '');
        }

        // å…¨è§’ç©ºç™½ã‚’åŠè§’ç©ºç™½ã«æ­£è¦åŒ–ã€é€£ç¶šåŒºåˆ‡ã‚Šã‚’å˜ä¸€ã‚¹ãƒšãƒ¼ã‚¹ã«ã™ã‚‹
        function normalizeSeparators(s) {
            // replace full-width space with normal space
            let t = s.replace(/\u3000/g, ' ');
            // replace various dash/colon variants with a single pipe marker
            const sepRegex = /[ \t\u3000\-â€”â€•:ï¼š\/ï¼_]+/g;
            t = t.replace(sepRegex, ' ');
            // trim
            return t.trim();
        }

        // ãƒ¡ã‚¤ãƒ³ã®æŠ½å‡ºãƒ­ã‚¸ãƒƒã‚¯
        function parseFileNameToCreatorTitle(rawFileName) {
            // rawFileName ã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒ†ã‚£ãƒ³ã‚°ã® href ã‹ã€index.txt ã®è¡Œãªã©
            // ã¾ãšãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ‘ã‚¹éƒ¨åˆ†ã‚’å–ã‚Šå‡ºã™
            let fileName = rawFileName;
            try {
                // URL ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã—ã¦ãƒ‘ã‚¹éƒ¨åˆ†ã®ã¿æŠ½å‡ºï¼ˆãƒ‘ã‚¹ãŒã‚ã‚Œã°æœ€å¾Œã®ãƒ‘ã‚¹åŒºåˆ‡ã‚Šä»¥é™ï¼‰
                const lastSlash = Math.max(fileName.lastIndexOf('/'), fileName.lastIndexOf('\\'));
                if (lastSlash >= 0) {
                    fileName = fileName.slice(lastSlash + 1);
                }
                // decode percent-encoding if present
                fileName = safeDecodeURIComponent(fileName);
            } catch(e) {
                // å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
            }

            const original = fileName;
            fileName = stripExtension(fileName).trim();

            // 1) æœ«å°¾ã«ä½œè€…ãŒæ‹¬å¼§ã§å…¥ã£ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³: ã€Œä½œå“åï¼ˆä½œè€…ï¼‰ã€ ã¾ãŸã¯ ã€Œä½œå“å(author)ã€
            //    å„ªå…ˆã—ã¦æ¤œå‡ºã™ã‚‹ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®é †åºãŒé€†ã®å ´åˆï¼‰
            let m = fileName.match(/^(.*)[\u3000\s]*[ï¼ˆ(]([^ï¼‰)]+)[ï¼‰)]\s*$/);
            if (m) {
                const title = m[1].trim();
                const creator = m[2].trim();
                if (title) return { creator: creator || 'ä½œè€…ä¸æ˜', title: title || original };
            }

            // 2) ãƒ•ãƒ«å¹…ç©ºç™½ã‚„åŠè§’ç©ºç™½ãªã©ã§åˆ†å‰²ï¼ˆå¤šãã® Windows ãƒ•ã‚¡ã‚¤ãƒ«ã¯ "ä½œè€…<space>ä½œå“å"ï¼‰
            //    å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŠè§’ã«ã—ã€ä»–ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚‚æ­£è¦åŒ–ã—ã¦ã‹ã‚‰æœ€åˆã®ç©ºç™½ã§åˆ†å‰²
            const norm = normalizeSeparators(fileName);
            if (norm.indexOf(' ') !== -1) {
                const parts = norm.split(' ');
                // ä½œè€…ãŒè¤‡æ•°èªã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŒã€ä¸€èˆ¬çš„ãªå½¢å¼ã‚’å„ªå…ˆï¼š
                // æœ€åˆã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œè€…ã€ãã‚Œä»¥é™ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«ã™ã‚‹
                const creator = parts[0].trim() || 'ä½œè€…ä¸æ˜';
                const title = parts.slice(1).join(' ').trim() || original;
                return { creator, title };
            }

            // 3) ãƒã‚¤ãƒ•ãƒ³ç³»ã‚„ã‚³ãƒ­ãƒ³ç³»ã§åˆ†å‰²ï¼ˆå…ƒãŒ "ä½œè€… - ä½œå“å" ã®ã‚ˆã†ãªå ´åˆï¼‰
            let sepMatch = fileName.match(/^(.*?)\s*[-:ï¼šâ€•â€”\/_]\s*(.+)$/);
            if (sepMatch) {
                const creator = sepMatch[1].trim() || 'ä½œè€…ä¸æ˜';
                const title = sepMatch[2].trim() || original;
                return { creator, title };
            }

            // 4) é€†ãƒ‘ã‚¿ãƒ¼ãƒ³: "ä½œå“å - ä½œè€…" ã®å ´åˆï¼ˆæœ«å°¾ã«çŸ­ã„æ–‡å­—åˆ—ãŒã‚ã‚‹ãªã‚‰ä½œè€…ã¨æ¨å®šï¼‰
            let revMatch = fileName.match(/^(.+?)\s*[-:ï¼šâ€•â€”\/_]\s*(.{1,30})$/);
            if (revMatch) {
                // é »å‡ºã™ã‚‹ä½œè€…åã¨æ€ã‚ã‚Œã‚‹çŸ­ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æœ«å°¾ã¨ã¿ãªã™
                const possibleCreator = revMatch[2].trim();
                const possibleTitle = revMatch[1].trim();
                if (possibleCreator && possibleTitle) {
                    return { creator: possibleCreator, title: possibleTitle };
                }
            }

            // 5) ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹ã‚„ã‚­ãƒ£ãƒ¡ãƒ«ã‚±ãƒ¼ã‚¹ã®è©¦è¡Œçš„åˆ†å‰²: '_' ã§åˆ†å‰²ã—ã¦æœ€åˆã‚’ä½œè€…ã«
            if (fileName.indexOf('_') !== -1) {
                const parts = fileName.split('_').map(s => s.trim()).filter(Boolean);
                if (parts.length >= 2) {
                    const creator = parts[0];
                    const title = parts.slice(1).join(' ');
                    return { creator, title };
                }
            }

            // 6) åŒºåˆ‡ã‚ŠãŒå…¨ããªã„å ´åˆï¼ˆä¾‹: "å¤ç›®æ¼±çŸ³å¤¢åå¤œ"ï¼‰ â€” æœ€æ‚ªã®ã‚±ãƒ¼ã‚¹
            //    æ¼¢å­—é€£ç¶šã‚’åˆ†å‰²ã™ã‚‹ã®ã¯ç¢ºå®Ÿã§ã¯ãªã„ãŸã‚ã€ã“ã“ã§ã¯ä½œè€…ä¸æ˜ã«ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«åå…¨ä½“ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«ã™ã‚‹
            return { creator: 'ä½œè€…ä¸æ˜', title: fileName || original };
        }

        // ---------- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾—ã¨è¡¨ç¤º ----------
        async function loadBookList() {
            try {
                let files = [];

                // 1) ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒ†ã‚£ãƒ³ã‚° (ã‚µãƒ¼ãƒãŒæœ‰åŠ¹ãªå ´åˆ)
                try {
                    const response = await fetch('xhtml/');
                    if (response.ok) {
                        const html = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        doc.querySelectorAll('a').forEach(a => {
                            let href = a.getAttribute('href');
                            if (!href) return;
                            // ä¸€éƒ¨ã‚µãƒ¼ãƒã¯ãƒªãƒ³ã‚¯ã‚’ç›¸å¯¾ã§å‡ºã™ã€çµ¶å¯¾ã§å‡ºã™ã€è‰²ã€…ã‚ã‚‹ãŸã‚ãã®ã¾ã¾å–ã‚Šå‡ºã™
                            // ãŸã ã— fragment ã‚„ query ãŒä»˜ã„ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§é™¤å¤–
                            href = href.split('#')[0].split('?')[0];
                            if (/\.(html|htm|xhtml)$/i.test(href)) files.push(href);
                        });
                    }
                } catch(e) {
                    // ignore
                }

                // 2) index.txt ãŒã‚ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (files.length === 0) {
                    try {
                        const resp = await fetch('xhtml/index.txt');
                        if (resp.ok) {
                            const txt = await resp.text();
                            txt.split(/\r?\n/).forEach(line => {
                                const t = line.trim();
                                if (t && /\.(html|htm|xhtml)$/i.test(t)) files.push(t);
                            });
                        }
                    } catch(e) {}
                }

                if (files.length === 0) {
                    contentDiv.innerHTML = `<div class="error">xhtml ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ã‚µãƒ¼ãƒãŒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒªã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿”ã™ã‹ã€<code>xhtml/index.txt</code> ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚</div>`;
                    return;
                }

                // process each file (filename-based parsing)
                fileList = files.map(f => {
                    // f ã«ã¯ç›¸å¯¾ãƒ‘ã‚¹è¦ç´ ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ï¼ˆä¾‹: %E5%A4%8F%E7%9B%AE.htmlï¼‰
                    const parsed = parseFileNameToCreatorTitle(f);
                    return {
                        path: `xhtml/${f}`.replace(/\/+/g, '/'), // ensure path
                        raw: f,
                        creator: parsed.creator,
                        title: parsed.title,
                        fileName: f
                    };
                });

                displayBooks();

            } catch(err) {
                contentDiv.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${escapeHtml(String(err))}</div>`;
            }
        }

        function displayBooks() {
            if (!fileList || fileList.length === 0) {
                contentDiv.innerHTML = '<div class="error">ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // ã‚½ãƒ¼ãƒˆï¼ˆä½œè€…â†’ã‚¿ã‚¤ãƒˆãƒ«ï¼‰
            const sorted = [...fileList].sort((a,b) => {
                const c = a.creator.localeCompare(b.creator, 'ja');
                if (c !== 0) return c;
                return a.title.localeCompare(b.title, 'ja');
            });

            const fontSize = fontSizeInput.value || '16px';

            const rows = sorted.map(book => {
                // file ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ viewer å´ã§ä½¿ã†ãŸã‚ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦æ¸¡ã™
                const url = `aozora-viewer.html?creator=${encodeURIComponent(book.creator)}&title=${encodeURIComponent(book.title)}&font-size=${encodeURIComponent(fontSize)}&file=${encodeURIComponent(book.path)}`;
                return `
                    <div class="book-item">
                        <div class="creator" title="${escapeHtml(book.creator)}">${escapeHtml(book.creator)}</div>
                        <a class="title-link" href="${url}" target="_blank" title="${escapeHtml(book.title)}">${escapeHtml(book.title)}</a>
                    </div>
                `;
            }).join('');

            contentDiv.innerHTML = `<div class="book-list">${rows}</div>`;
        }

        function escapeHtml(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // èµ·å‹•
        loadBookList();

    })();
    </script>
</body>
</html>
